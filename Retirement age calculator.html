<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Age Calculator</title>
    <link rel="stylesheet" href="styles.css"> <!-- Your separate CSS file -->
</head>
<body>

    <div class="container">
        <h1>Retirement Age Calculator</h1>

        <!-- Input Form -->
        <div id="inputSection">
            <form id="retirementForm">

                <h2>Investment Details</h2>
                <label>Expected return on SIP (% per year):</label>
                <input type="number" step="0.1" id="yield" required><br>

                <label>Monthly SIP amount (₹):</label>
                <input type="number" id="sip" required><br>

                <label>Annual SIP step-up (%): <small>(0 if none)</small></label>
                <input type="number" step="0.1" id="stepUp" value="0" required><br>

                <label>Current Fixed Deposit amount (₹):</label>
                <input type="number" id="fd" value="0"><br>

                <label>FD annual rate (%):</label>
                <input type="number" step="0.1" id="fd_yield" value="0"><br>

                <label>Current Mutual Fund/Equity amount (₹):</label>
                <input type="number" id="mf" value="0"><br>

                <label>Expected MF annual return (%):</label>
                <input type="number" step="0.1" id="mf_yield" required><br><br>

                <h2>Personal Details</h2>
                <label>Current age:</label>
                <input type="number" id="current_age" required><br>

                <label>Life expectancy:</label>
                <input type="number" id="expectancy" required><br>

                <label>Expected monthly expense at retirement start (₹):</label>
                <input type="number" id="expense" required><br>

                <label>Expected annual inflation (%):</label>
                <input type="number" step="0.1" id="inflation" required><br>

                <label>Expected annual return during retirement (%):</label>
                <input type="number" step="0.1" id="corpus_yield" required><br>

                <label>Effective tax on gains withdrawn in retirement (%):</label>
                <input type="number" step="0.1" id="tax_pct" value="10"><br><br>

                <h2>Retirement Incomes (optional)</h2>
                <label>Monthly recurring income (e.g., pension) (₹):</label>
                <input type="number" id="monthlyPay" value="0"><br>

                <label>Annual increase for monthly income (%):</label>
                <input type="number" step="0.1" id="monthlyPayInc" value="0"><br>

                <label>Yearly recurring income (e.g., rent) (₹):</label>
                <input type="number" id="yearlyPay" value="0"><br>

                <label>Annual increase for yearly income (%):</label>
                <input type="number" step="0.1" id="yearlyPayInc" value="0"><br><br>

                <h2>Large One-Time Expenses (max 5)</h2>
                <div id="withdrawals">
                    <!-- Dynamic withdrawal fields added via JS -->
                </div>
                <button type="button" id="addWithdrawal">Add Withdrawal</button><br><br>

                <h2>Irregular Inflows Before/At Retirement (max 3)</h2>
                <div id="inflows">
                    <!-- Dynamic inflow fields added via JS -->
                </div>
                <button type="button" id="addInflow">Add Inflow</button><br><br>

                <button type="submit">Calculate Retirement Age</button>
            </form>
        </div>

        <!-- Loading & Result Section -->
        <div id="loading" class="hidden">
            <p>Calculating... Please wait.</p>
        </div>

        <div id="result" class="hidden">
            <h2>Result</h2>
            <p id="resultText"></p>
            <p id="corpusText"></p>
            <button id="newCalculation">New Calculation</button>
        </div>
    </div>

    <script>
        // Track dynamic fields
        let withdrawalCount = 0;
        let inflowCount = 0;
        const maxWithdrawals = 5;
        const maxInflows = 3;

        // Add withdrawal field
        document.getElementById('addWithdrawal').addEventListener('click', () => {
            if (withdrawalCount >= maxWithdrawals) {
                alert('Maximum 5 withdrawals allowed');
                return;
            }
            withdrawalCount++;
            const div = document.createElement('div');
            div.id = `w${withdrawalCount}`;
            div.innerHTML = `
                <label>Withdrawal ${withdrawalCount} amount (₹):</label>
                <input type="number" class="w-amount" value="0"><br>
                <label>Age when it occurs:</label>
                <input type="number" class="w-age" required><br>
            `;
            document.getElementById('withdrawals').appendChild(div);
        });

        // Add inflow field
        document.getElementById('addInflow').addEventListener('click', () => {
            if (inflowCount >= maxInflows) {
                alert('Maximum 3 inflows allowed');
                return;
            }
            inflowCount++;
            const div = document.createElement('div');
            div.id = `i${inflowCount}`;
            div.innerHTML = `
                <label>Inflow ${inflowCount} amount (₹):</label>
                <input type="number" class="i-amount" value="0"><br>
                <label>Age when it occurs:</label>
                <input type="number" class="i-age" required><br>
            `;
            document.getElementById('inflows').appendChild(div);
        });

        // Form submit
        document.getElementById('retirementForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Show loading, hide input
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            // Collect inputs
            const data = {
                yield: parseFloat(document.getElementById('yield').value),
                sip: parseFloat(document.getElementById('sip').value),
                stepUp: parseFloat(document.getElementById('stepUp').value),
                fd: parseFloat(document.getElementById('fd').value || 0),
                fd_yield: parseFloat(document.getElementById('fd_yield').value || 0),
                mf: parseFloat(document.getElementById('mf').value || 0),
                mf_yield: parseFloat(document.getElementById('mf_yield').value),
                current_age: parseInt(document.getElementById('current_age').value),
                expectancy: parseInt(document.getElementById('expectancy').value),
                expense: parseFloat(document.getElementById('expense').value),
                inflation: parseFloat(document.getElementById('inflation').value),
                corpus_yield: parseFloat(document.getElementById('corpus_yield').value),
                tax_pct: parseFloat(document.getElementById('tax_pct').value) / 100,
                monthlyPay: parseFloat(document.getElementById('monthlyPay').value || 0),
                monthlyPayInc: parseFloat(document.getElementById('monthlyPayInc').value || 0) / 100,
                yearlyPay: parseFloat(document.getElementById('yearlyPay').value || 0),
                yearlyPayInc: parseFloat(document.getElementById('yearlyPayInc').value || 0) / 100,
                withdrawals: [],
                inflows: []
            };

            // Collect withdrawals
            document.querySelectorAll('#withdrawals > div').forEach(div => {
                const amount = parseFloat(div.querySelector('.w-amount').value) || 0;
                const age = parseInt(div.querySelector('.w-age').value);
                if (amount > 0 && age) {
                    data.withdrawals.push({amount, age});
                }
            });

            // Collect inflows
            document.querySelectorAll('#inflows > div').forEach(div => {
                const amount = parseFloat(div.querySelector('.i-amount').value) || 0;
                const age = parseInt(div.querySelector('.i-age').value);
                if (amount > 0 && age) {
                    data.inflows.push({amount, age});
                }
            });

            // Run calculation (ported from the correct C logic)
            const result = calculateRetirement(data);

            // Show result
            setTimeout(() => { // Simulate slight delay for realism
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('result').classList.remove('hidden');
                if (result.found) {
                    document.getElementById('resultText').innerHTML = `<strong>You can safely retire at age ${result.age}</strong>`;
                    document.getElementById('corpusText').innerHTML = `Corpus at retirement: ₹${result.corpus.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
                } else {
                    document.getElementById('resultText').innerHTML = `<strong>No safe retirement age found up to age ${data.expectancy}</strong>`;
                    document.getElementById('corpusText').innerHTML = '';
                }
            }, 300);
        });

        // New calculation button
        document.getElementById('newCalculation').addEventListener('click', () => {
            document.getElementById('result').classList.add('hidden');
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('retirementForm').reset();
            document.getElementById('withdrawals').innerHTML = '';
            document.getElementById('inflows').innerHTML = '';
            withdrawalCount = 0;
            inflowCount = 0;
        });

        // Core calculation function (faithful port of the C logic)
        function calculateRetirement(d) {
            for (let retire_age = d.current_age + 1; retire_age <= d.expectancy - 1; retire_age++) {
                const years_to_retire = retire_age - d.current_age;

                // SIP FV - month by month with step-up
                const monthly_rate = Math.pow(1 + d.yield/100, 1/12) - 1;
                const total_months = years_to_retire * 12;
                let sip_fv = 0;
                for (let m = 0; m < total_months; m++) {
                    const year_index = Math.floor(m / 12);
                    const contribution = d.sip * Math.pow(1 + d.stepUp/100, year_index);
                    const months_remaining = total_months - m;
                    sip_fv += contribution * Math.pow(1 + monthly_rate, months_remaining);
                }

                // FD & MF FV
                const fd_fv = d.fd * Math.pow(1 + d.fd_yield/100, years_to_retire);
                const mf_fv = d.mf * Math.pow(1 + d.mf_yield/100, years_to_retire);

                // Pre-retirement inflows/withdrawals adjusted to retirement date
                let pre_inflows = 0;
                let pre_withdrawals = 0;
                d.inflows.forEach(i => {
                    if (i.age <= retire_age) {
                        const gap = retire_age - i.age;
                        pre_inflows += i.amount * Math.pow(1 + d.corpus_yield/100, gap);
                    }
                });
                d.withdrawals.forEach(w => {
                    if (w.age <= retire_age) {
                        const gap = retire_age - w.age;
                        pre_withdrawals += w.amount * Math.pow(1 + d.corpus_yield/100, gap);
                    }
                });

                let future_corpus = sip_fv + fd_fv + mf_fv + pre_inflows - pre_withdrawals;

                // Retirement simulation
                let principalLeft = future_corpus;
                let gainsLeft = 0;
                let annualExpense = d.expense * 12;
                let currentMonthlyPay = d.monthlyPay;
                let currentYearlyPay = d.yearlyPay;

                let survived = true;
                const retirement_years = d.expectancy - retire_age;

                for (let y = 0; y < retirement_years; y++) {
                    const totalBefore = principalLeft + gainsLeft;
                    const interest = totalBefore * (d.corpus_yield / 100);
                    gainsLeft += interest;

                    let yearlyIncome = currentMonthlyPay * 12 + currentYearlyPay;
                    let need = annualExpense - yearlyIncome;

                    const thisYearAge = retire_age + y;

                    // One-time withdrawals this year
                    d.withdrawals.forEach(w => {
                        if (w.age === thisYearAge) need += w.amount;
                    });
                    // One-time inflows this year
                    d.inflows.forEach(i => {
                        if (i.age === thisYearAge) need -= i.amount;
                    });

                    if (need <= 0) {
                        // No withdrawal needed
                    } else if (need <= principalLeft + 1e-9) {
                        principalLeft -= need;
                    } else {
                        const taxable = need - principalLeft;
                        principalLeft = 0;
                        const tax = taxable * d.tax_pct;
                        const gross = taxable + tax;
                        if (gainsLeft < gross - 1e-9) {
                            survived = false;
                            break;
                        }
                        gainsLeft -= gross;
                    }

                    if (!survived) break;

                    // Escalate for next year
                    annualExpense *= (1 + d.inflation/100);
                    currentMonthlyPay *= (1 + d.monthlyPayInc);
                    currentYearlyPay *= (1 + d.yearlyPayInc);
                }

                if (survived) {
                    return {found: true, age: retire_age, corpus: future_corpus};
                }
            }
            return {found: false};
        }
    </script>
</body>
  </html>
